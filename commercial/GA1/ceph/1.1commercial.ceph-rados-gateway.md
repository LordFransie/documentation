---
layout: default
title: "HP Helion OpenStack&#174; HP Helion Ceph RADOSGW"
permalink: /helion/openstack/1.1/ceph-rados-gateway/
product: commercial
product-version1: HP Helion OpenStack
product-version2: HP Helion OpenStack 1.1
role1: Storage Engineer
role2: Storage Architect 
role3: Storage Administrator 
role4: Storage Engineer
role5: Service Developer 
role6: Cloud Administrator 
role7: Application Developer 
authors: Paul F

---
<!--PUBLISHED-->


<script>

function PageRefresh {
onLoad="window.refresh"
}

PageRefresh();

</script>
<!--
<p style="font-size: small;"> <a href="/helion/openstack/1.1/install-beta/kvm/">&#9664; PREV</a> | <a href="/helion/openstack/1.1/install-beta-overview/">&#9650; UP</a> | <a href="/helion/openstack/1.1/install-beta/esx/">NEXT &#9654;</a> </p> --->

# Ceph Reliable Autonomic Distributed Object Store Gateway (RADOSGW) for Helion OpenStack 1.1

The Ceph RADOS Gateway offers Swift API access to objects stored in Ceph. It is this object storage interface that uses the Ceph Object Gateway daemon - `radosgw`. `radosgw` FastCGI module for interacting with the Ceph storage cluster. For more details, refer to [http://http://ceph.com/docs/master/radosgw/](http://http://ceph.com/docs/master/radosgw/)


RADOS gateway is setup on a discrete node which eventually becomes an integral part of Ceph cluster. The existing Ceph cluster is easily extended by adding gateway node. For more details, refer to[http://http://ceph.com/docs/master/install/install-ceph-gateway/](http://http://ceph.com/docs/master/install/install-ceph-gateway/)

A load balance is required for a high availability (HA) RADOS Gateway installations. HAProxy is an example of a load balancer that is used with RADOS Gateway endpoints. For implementing the HA RADOS Gateway, a second gateway node is set up similarly to the first one but a  unique client is required for a second node. The following section explains the HA RADOS Gateway set up.


###Configuring the Administration Node

Perform the following steps from the Ceph admin node. It is assumed that the hostname for a gateway node is `gateway`, and the host name of the second node (for HA) is `gateway1`. 

It is recommended to stand up first node successfully before proceeding to second node.


1. Log in to admin node as default hlinux user and execute all the following commands as `sudo`.

2. Confirm the status of Ceph cluster health is OK:
	
		ceph health

2. Change the directory by entering:
	
		cd  /etc/ceph

3. Create a keyring for a gateway and associate the required permission by entering:

		ceph-authtool --create-keyring /etc/ceph/ceph.client.radosgw.keyring
		chmod +r /etc/ceph/ceph.client.radosgw.keyring

4. To generate a gateway username and key (the default user is **gateway**), enter:


		ceph-authtool /etc/ceph/ceph.client.radosgw.keyring -n client.radosgw.gateway --gen-key

	For HA, create additional user - `gateway1` by entering:

		ceph-authtool /etc/ceph/ceph.client.radosgw.keyring -n client.radosgw.gateway1 --gen-key

6.  Add key capabilities by entering:

		ceph-authtool -n client.radosgw.gateway --cap osd 'allow rwx' --cap mon 'allow rwx' /etc/ceph/ceph.client.radosgw.keyring

	 For HA, add key capabilities to the `gateway1` user, by entering:

		ceph-authtool -n client.radosgw.gateway1 --cap osd 'allow rwx' --cap mon 'allow rwx' /etc/ceph/ceph.client.radosgw.keyring

7. Add a key to the Ceph cluster by entering:

		ceph -k /etc/ceph/ceph.client.admin.keyring auth add client.radosgw.gateway -i /etc/ceph/ceph.client.radosgw.keyring

	For HA, add a key for the `gateway1` user by entering:

		ceph -k /etc/ceph/ceph.client.admin.keyring auth add client.radosgw.gateway1 -i /etc/ceph/ceph.client.radosgw.keyring

8. Copy a keyring to the gateway node(s) by entering:

		scp /etc/ceph/ceph.client.radosgw.keyring root@gateway:/etc/ceph

9.  Add the gateway user configurations by updating the `ceph.conf` file as shown below. Make sure that the hostname of the gateway node(s) is considered for both host and RGW DNS  name fields by entering:

		[client.admin]
		keyring = /etc/ceph/ceph.client.admin.keyring

		[client.radosgw.gateway]
		host = gateway
		keyring = /etc/ceph/ceph.client.radosgw.keyring
		rgw socket path = /var/run/ceph/ceph.radosgw.gateway.fastcgi.sock
		log file = /var/log/ceph/client.radosgw.gateway.log
		rgw dns name = gateway
		rgw print continue = false

		# Added for HA
		[client.radosgw.gateway1]
		host = gateway1
		keyring = /etc/ceph/ceph.client.radosgw.keyring
		rgw socket path = /var/run/ceph/ceph.radosgw.gateway.fastcgi.sock
		log file = /var/log/ceph/client.radosgw.gateway.log
		rgw dns name = gateway1
		rgw print continue = false

10. Re-deploy the Ceph configuration on all cluster nodes and client nodes.

###Configuring the Gateway Node

Perform the following steps on the gateway node. For HA implementations, you will repeat similar steps on the failover node as noted.

1. Log in to admin node as default hlinux user and execute all the following commands as `sudo`.

2. Check if the relevant services are in a good state. Services include `dnsmasq`, `radosgw`, `apache2`, and `ceph`. If they are not in good state, fix the issue before proceeding. Check service status by entering:

		/etc/init.d/<service> status

	For example, to check the service status for `dnsmasq`, enter:

		/etc/init.d/dnsmasq status


3. Configure Apache2 and/or FastCGI. <br />
Edit the `/etc/apache2/apache2.conf` file to include the server name of the gateway node(s) as follows: 
    
		ServerName gateway.ex.com

	Note that, for HA, the second node is:

		ServerName gateway1.ex.com

6. Enable URL rewrite modules for Apache2 and FastCGI by entering:

		a2enmod rewrite
		a2enmod fastcgi

7. Restart Apache2 for the changes to take effect by entering:

		/etc/init.d/apache2 restart

8. Enable SSL by entering:

			a2enmod ssl

3. Generate the SSL certificate by entering:

			mkdir /etc/apache2/ssl
			openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/apache2/ssl/apache.key -out /etc/apache2/ssl/apache.crt

4. Restart Apache2 by entering:

			/etc/init.d/apache2 restart

9. Edit `/etc/hosts` file to include the `fqdn` of a gateway node by entering:

		192.x.x.x gateway.ex.com gateway

10. For HA, second node is:
	
		192.x.x.x gateway1.ex.com gateway1

11. Add wildcard support to DNS by following these steps.


	2. Edit `/etc/dnsmasq.conf` as follows:

			address=/.{fqdn}/{host ip}
			listen-address=127.0.0.1

		For example -

			address=/.gateway.ex.com/192.x.x.x
			listen-address=127.0.0.1

	3. For HA, the second node is:

		address=/.gateway1.ex.com/192.x.x.x
		listen-address=127.0.0.1

	4. Restart dsnmasq by entering:

			/etc/init.d/dnsmasq restart

	5. Ping the server with the subdomain to ensure RADOSGW can process subdomain requests by entering:

			ping mybucket.{fqdn}
			ping mybucket.gateway.ex.com

		**NOTE**: Make sure that `mybucket.gateway.ex.com` is defined in the `/etc/hosts` file. Otherwise, ping will fail.

14. Add the Ceph Object Gateway script `s3gw.fcgi in /var/www` directory with the file contents as shown below:

		#!/bin/sh
		exec /usr/bin/radosgw -c /etc/ceph/ceph.conf -n client.radosgw.gateway

15. Provide proper file permission by entering:

		chmod +x s3gw.fcgi

16. For HA, second node will be:

		#!/bin/sh
		exec /usr/bin/radosgw -c /etc/ceph/ceph.conf -n client.radosgw.gateway1

17. Create a data directory by entering:

		mkdir -p /var/lib/ceph/radosgw/ceph-radosgw.gateway

18. Add the gateway configuration file `rgw.conf in /etc/apache2/sites-available` directory with file contents as shown below:

		FastCgiExternalServer /var/www/s3gw.fcgi -socket /var/run/ceph/ceph.radosgw.gateway.fastcgi.sock
		
		<VirtualHost *:443>
		
			ServerName gateway.ex.com
			ServerAlias *.gateway.ex.com
			ServerAdmin gateway@hp.com
			DocumentRoot /var/www
			RewriteEngine On
			RewriteRule ^/(.*) /s3gw.fcgi?%{QUERY_STRING} [E=HTTP_AUTHORIZATION:%{HTTP:Authorization},L]
			
			<IfModule mod_fastcgi.c>
				<Directory /var/www>
					Options +ExecCGI
					AllowOverride All
					SetHandler fastcgi-script
					Order allow,deny
					Allow from all
					AuthBasicAuthoritative Off
				</Directory>
			</IfModule>
			
			AllowEncodedSlashes On
			ErrorLog /var/log/apache2/error.log
			CustomLog /var/log/apache2/access.log combined
			ServerSignature Off
			
			SSLEngine on
	        SSLCertificateFile /etc/apache2/ssl/apache.crt
	        SSLCertificateKeyFile /etc/apache2/ssl/apache.key
	        SetEnv SERVER_PORT_SECURE 443

		</VirtualHost>

	**Note**: For HA, second node will have changes for `ServerName`, `ServerAlias` and `ServerAdmin` accordingly.

19. Enable a site for `rgw.conf` by entering:

		a2ensite rgw.conf

20. Disable a default site by entering:

		a2dissite 000-default

21. Restart all services and start a gateway by entering:

	*  Apache2:

			 /etc/init.d/apache2 restart

	* Gateway RADOSGW:

			/etc/init.d/radosgw start

	* RADOSGW in a debug mode for troubleshooting:

			/usr/bin/radosgw -d -c /etc/ceph/ceph.conf --debug-rgw 20 --rgw-socket-path=/var/run/ceph/ceph.radosgw.gateway.fastcgi.sock
<!---
	* Ceph:

			/etc/init.d/ceph restart
-->

<!---
###Validating the Installation

Once all the services are up and running, make an anonymous GET request to the gateway instance to make sure you can receive a valid response.

1. Make sure that the proxy is not set on a gateway node(s) by entering:
    
    	unset http_proxy https_proxy
    
2. Execute the RADOSGW service in debug mode to ensure that there are no obvious errors in the logs on both gateway nodes:

		/usr/bin/radosgw -d -c /etc/ceph/ceph.conf --debug-rgw 20 --rgw-socket-path=/var/run/ceph/ceph.radosgw.gateway.fastcgi.sock

3. From the controller node, make a Swift v1 request as shown below. The IP address used will be the Helion VIP address followed by the RADOSGW service port. Make sure the s3 and Swift user are created using the `radosgw-admin` commands. The output should list containers if any. 

		swift --insecure -V 1.0 -A https://192.0.2.x:10080/auth/v1.0 -U s3User:swiftUser -K abc list

4. From the controller node, make a Swift v2 request using Keystone. The Ceph Object Gateway user:subuser tuple maps to the tenant:user tuple expected by Swift. The IP address used will be the Helion VIP address followed by the Keystone service port. Here, admin credentials are considered. Output should list containers if any.

		swift -V 2.0 -A https://192.0.2.x:5000/v2.0 -U admin:admin -K abc list


	This response indicates that gateway instance is working as expected.

5. If the above Swift calls fail, make sure port 10080 is open on all controller nodes. Then verify if certificates in use have not expired. If they have expired, copy the respective certificates from Helion nodes like explained above.

6. From the controller node, get the admin tenant ID by entering:

		Keystone tenant-list

A sample of the output from this command is:
    
    +----------------------------------+---------+---------+
    |id|   name  | enabled |
    +----------------------------------+---------+---------+
    | 627770d0c17c4423b8c27a2607e60798 |  admin  |   True  |
    | aa70711bd69e4958ac239e2564c18054 |   demo  |   True  |
    | 250bf66045814455a5b3c3e6c7fb7c19 | service |   True  |
    +----------------------------------+---------+---------+
    

7. Verify that the admin tenant is created in the RADOS  pool  by entering:

		rados --pool .users.uid ls

	A sample of the output from this command is:
  

		s3User
    	s3User.buckets
    	627770d0c17c4423b8c27a2607e60798 
    	627770d0c17c4423b8c27a2607e60798.buckets
    
-->
<!---Binamra - I think pools, users, etc is a separate topic. Would you make this its own file?-->
    



<a href="#top" style="padding:14px 0px 14px 0px; text-decoration: none;"> Return to Top &#8593; </a>