---
layout: default
title: "HP Cloud Networking: VPN setup quick start guide"
permalink: /vpn-quickstart/

---
# HP Cloud Networking: VPN setup quick start guide
With HP Cloud Networking you can set up an IPSec, or site-to-site, VPN connecting your external network directly to your HP cloud virtual network. This guide provides the basic instructions to set this up.

## Overview ## {#top}
HP Cloud Networking, based on OpenStack Networking, gives you a broad new spectrum of functionality to define and configure virtual networks.

A default network configuration comes with HP Cloud Compute Service activation. Your network is ready to deploy HP Cloud Compute virtual machines (instances) without further configuration required. The default configuration includes:

- A network
- A subnet
- A router connecting the subnet to the Internet
- A security group with basic server options

The purpose of this guide it to provide instructions to create an IPSec VPN (also known as site-to-site VPN) from your external network directly into your HP Cloud virtual network.

**Note:** This guide uses strongSwan for the IPSec functionality.

A site-to-site VPN allows multiple fixed locations to establish secure connections with each other over a public network such as the Internet. Site-to-site VPN extends a defined network, making computer resources from one network available to other networks.

For VPN site-to-site connectivity, you will need to modify either the provided default network configuration or create your own network, subnet, router and ports using the OpenStack Networking API.  The customization can be done on either the command line or through the HP Cloud Services Management Console.  

Ensure before starting that you have adequate permissions to accomplish each of the below steps.  

**Note:** VPN instances are a potential single point of failure.

The following sections walk you throught the process of setting up a basic site-to-site VPN:

- [Audience](#audience)
- [Key terms](#terms)
- [Quick start](#quickstart)
- [Tips and best practices](#tips)
- [Troubleshooting](#troubleshooting)
- [References](#refs)

###Audience### {#audience}

This guide is designed for the following people:

- Networking Engineers    
- Networking Administrators
- Cloud Administrators

To use this solution effectively, you should be familiar with the below concepts and information:

- Local network configuration in HP Public Cloud     
- HP Cloud Compute and Networking services 
- OpenStack Nova and Neutron CLI and API   
- Virtual Private Networks (VPN)    
- strongSwan or other IPSec based software solutions

###Key terms### {#terms}
The following terms are used throughout this guide:

**IKE**: Internet Key Exchange

**IPSec**: Internet Protocol Security (IPSec) is a technology protocol suite for securing Internet Protocol (IP) communications by authenticating and/or encrypting each IP packet of a communication session. IPSec also includes protocols for establishing mutual authentication between agents at the beginning of the session and negotiation of cryptographic keys to be used during the session.

**NAT-T**: Network Address Translation - Traversal

**strongSwan**: strongSwan is an open source IPSec implementation for Linux 2.6 and 3.x kernels. The focus of the project is on strong authentication mechanisms using X.509 public key certificates and optional secure storage of private keys on smartcards through a standardized PKCS#11 interface.

##Quick Start Guide## {#quickstart}

This guide provides the information you will need to get started in setting up a VPN that connects your local network to your Virtual Private Cloud (VPC) located in the HP Cloud.  In this tutorial, you create two instances--one as an example to use and the other as a gateway.

**NOTE:**  This tutorial assumes a "left" case with the "right" case being the hardware.  

For the purpose of this tutorial, we use strongSwan.  There are multiple ways to configure strongSwan and the instructions in this guide may not work for every environment.  Please refer to the strongSwan user documentation for advanced configuration information that may not be included in this guide.

All instructions are provided using command line interactions. 

The following steps take you through the process of setting up the VPN:

[Sign up for HP Cloud Services and activate the compute service](#compute)  
[Set up VPC and Internet gateway](#gtwy)  
[Set up a security group](#secgrp)   
[Create ports and disable anti-spoofing](#port)   
[Create compute instances](#instances)
[Associate floating IPs](#floatip)  
[Install strongSwan](#installss)  
[Enable IP forwarding](#ipfrwrd)
[Set up *ipsec.conf* on the gateway](#ipsec)
[Set up Shared Secret](#secret)
[Set up routes on non-gateway instance](#routes) 
[Establish connections](#connect)

In this tutorial we will use the below parameters:

$EXT_NET = Ext_Net   
$CIDR = 10.2.0.0./24 (example range)   
$NETWORK_ID = the id of the created network   
$SUBNET_ID = the id of the created subnet   
$TENANT_ID = the id of the tenant   
$PORT_ID1 = id of port 1 (vm-gateway)     
$PORT_ID2 = id of port 2 (vm-test)    
$VM_GATEWAY = address of the VPN VM gateway (i.e., 10.10.10.5) 

For more details on the Nova and Neutron commands please see the HP Cloud Networking and Compute API specifications.


###Sign up for HP Cloud and activate a compute instance### {#compute}
If you have not previously created an account and activated the Compute Service please start at [http://hpcloud.com](http://hpcloud.com) to start the process.  Once you activate a compute instance, you can start creating your VPC VPN.

###Set up VPC and Internet gateway### {#gtwy}


####Create the router and set the gateway on the router
Create the router **vpn_router** and set its gateway to be the external network.

    neutron router-create vpn_router
    neutron subnet-create $NETWORK_ID $CIDR

####Attach the router to the subnet  

    neutron router-interface-add vpn_router $SUBNET_ID  


###Set up a security group### {#secgrp}

You can perform these tasks using either the management console or the command line. In this guide we use the command line. 

In the example below we name the security group **ipsec_vpn_gateway**.

1. Create security group   
    `neutron security-group-create ipsec_vpn_gateway`
  
2. Add security group rule to allow the UDP port 500 for IKE messages
	`neutron security-group-rule-create --direction ingress --protocol udp --port-range-min 500 --port-range-max 500 ipsec_vpn_gateway`  
 
3. Add security group rule to allow the UDP port 4500 for IKE messages when using NAT-T
	`neutron security-group-rule-create --direction ingress --protocol udp --port-range-min 4500 --port-range-max 4500 ipsec_vpn_gateway`  
  
4. Add security group rule to allow the TCP port 1293 for the IPsec messages
	`neutron security-group-rule-create --direction ingress --protocol tcp --port-range-min 1293 --port-range-max 1293 ipsec_vpn_gateway`    
 	 	
5. Add security group rule to allow ssh    
	`neutron security-group-rule-create --direction ingress --protocol tcp --port-range-min 22 --port-range-max 22 ipsec_vpn_gateway`    
 
6. Add security group rule to allow icmp   
	`neutron security-group-rule-create --direction ingress --protocol icmp ipsec_vpn_gateway` 


###Create ports and disable anti-spoofing### {#port}

Create two ports and disable the port security on both ports.  

**NOTE:** disabling port security will disable the use of all security groups on the port.
    
	neutron port-create $NETWORK_ID --port_security_enabled False --name $PORT_ID1
	neutron port-create $NETWORK_ID --port_security_enabled False --name $PORT_ID2

Ports can be viewed with **neutron port-list** command.

    neutron port-list

    +---------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
    | id                                    | name |  mac_address      | fixed_ips                                                                           |
    +---------------------------------------+--------------------------+-------------------------------------------------------------------------------------+
    | baf13412-2641-4183-9533-de8f5b91444c  |      | fa:16:3e:f6:ec:c7 | {"subnet_id": "15a09f6c-87a5-4d14-b2cf-03d97cd4b456", "ip_address": "192.168.2.2"}  |
    | f7a08fe4-e79e-4b67-bbb8-a5002455a493| |      | fa:16:3e:97:e0:fc | {"subnet_id": "15a09f6c-87a5-4d14-b2cf-03d97cd4b456", "ip_address": "192.168.2.40"} |
    +---------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+




    $ nova availability-zone-list

    +----------+---------------+
    | Name     | Status        |
    +----------+---------------+
    | az1      | available     |
    | az2      | available     |
    | az3      | available     |
    +----------+---------------+
Using the API, you can also specify the availability zone when you create an instance or volume using `-availability_zone az#`

For example: `$ nova boot ... --availability-zone az1 ...`

If you don't specify an availability zone the compute or storage service automatically assigns one. So, if you do require redundancy for your virtual machines or volumes make sure to specify different availability zones for each.

**Important:** Volumes can only be attached to servers created in the same availability zone.

## Image Management ## {#Image}
With the new version of HP Cloud Compute the Image Management service, based on OpenStack Glance, is now exposed as a separate API endpoint. This provides for more control over images and we will be adding more functionality to this going forward.

## Networking ## {#Network}
In the current version of HP Cloud Compute, you have basic networking to use with instances. HP Cloud v13.5 builds on the OpenStack Networking service complemented with SDN technology from HP Networking to offer more robust networking capabilities and the ability to fine tune your network as needed. Spinning up a compute instance automatically configures

- A default network 
- A subnet
- A router connected to the subnet and externally to the Internet
- A security group with basic server options

Our [Networking API](/api/v13/networking/) or the [Management Console](/mc/compute/networks/) exposes a rich set of additional functionality including the ability to 

- Define and configure your own private Virtual L2 Networks
- Establish Virtual Private Network (VPN) connection to the networks you create 
- Specify IP address ranges and security group parameters that define the firewall rules for your instances
- Allocate and manage public floating IP addresses
- Connect to a specific network
- Connect an instance to more than one network

You also have the ability to set communication rules (security group rules) for both inbound and outbound traffic, create separate networks with their own IP address ranges, and control how servers connect to them.  As a region-wide service you have the ability to

- Use a single API endpoint per region 
- Connect networks in different Availability Zones to the same virtual L2 network
- Have your security groups span all Availability Zones in a region
- Map floating IP addresses to any Availability Zone in a region

## Block Storage ## {#BlockSt}
Block storage has always been available in the HP Cloud Compute service, but now HP Cloud provides it as a separate but integrated service based on OpenStack Cinder.  Block storage provides persistent, manageable volumes along with the ability to take a snapshot of a volume.   Bootable volumes can be created from images in the Image Management service and these bootable volumes can be used to create persistent instances.  The physical implementation of our storage solution is based on technology developed in HP labs and provides enterprise class volume availability.
